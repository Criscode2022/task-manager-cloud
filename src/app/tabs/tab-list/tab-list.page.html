<ion-header class="ion-no-border">
  <ion-toolbar class="toolbar-gradient md:py-4">
    <h1
      class="ion-text-center text-xl lg:text-4xl font-extrabold tracking-tight"
    >
      <span>Task Manager</span>
    </h1>
    <button
      slot="end"
      class="filter-button md:absolute md:right-8 lg:text-xl ion-margin px-4 py-2 bg-white text-black rounded-full shadow-md flex justify-center items-center hover:bg-gray-200 focus:bg-gray-300"
      (click)="taskService.changeFilter()"
      matTooltip="Filter tasks"
      matTooltipPosition="below"
    >
      <mat-icon class="mr-1">filter_list</mat-icon>
      {{filter()}}
    </button>
  </ion-toolbar>
</ion-header>

<ion-content [scrollY]="false" class="content-background">
  <div class="form-container">
    <form
      [formGroup]="form"
      class="task-form animate-slide-in-up"
      (ngSubmit)="addTask()"
    >
      <div
        class="form-header"
        (click)="isFormVisible.set(!isFormVisible())"
        style="cursor: pointer"
      >
        <div class="flex items-center gap-3">
          <ion-icon name="add-circle-outline" class="header-icon"></ion-icon>
          <h2 class="form-title">Create New Task</h2>
        </div>

        <ion-icon
          [matTooltip]="isFormVisible() ? 'Collapse form' : 'Expand form'"
          slot="icon-only"
          [name]="isFormVisible() ? 'chevron-up-outline' : 'chevron-down-outline'"
        ></ion-icon>
      </div>

      @if (isFormVisible()) {
      <mat-form-field appearance="outline" class="form-field">
        <mat-label>Task Title</mat-label>
        <input
          matInput
          type="text"
          placeholder="What do you need to do?"
          formControlName="title"
          maxlength="40"
        />
        <mat-hint align="end">{{this.title?.value?.length || 0}}/40</mat-hint>
        <button
          *ngIf="this.title?.value?.length"
          mat-icon-button
          type="button"
          matSuffix
          class="clear-button"
          (click)="clear('title')"
          matTooltip="Clear title"
        >
          <mat-icon>close</mat-icon>
        </button>
      </mat-form-field>

      <mat-form-field appearance="outline" class="form-field mt-3">
        <mat-label>Description (Optional)</mat-label>
        <input
          matInput
          type="text"
          placeholder="Add more details..."
          formControlName="description"
          maxlength="30"
        />
        <mat-hint align="end"
          >{{this.description?.value?.length || 0}}/30</mat-hint
        >
        <button
          *ngIf="this.description?.value?.length"
          mat-icon-button
          type="button"
          matSuffix
          class="clear-button"
          (click)="clear('description')"
          matTooltip="Clear description"
        >
          <mat-icon>close</mat-icon>
        </button>
      </mat-form-field>

      <ion-button
        type="submit"
        expand="block"
        color="primary"
        class="submit-button"
        [disabled]="!form.valid"
      >
        <ion-icon slot="start" name="add-outline"></ion-icon>
        Add Task
      </ion-button>
      }
    </form>
  </div>

  <div class="tasks-container">
    <ion-list class="task-list">
      <div class="task-grid">
        @for (task of filteredTasks(); track task.id; let index = $index) {

        <ion-item-sliding
          class="task-item-sliding animate-scale-in md:pt-0.5"
          [style.animation-delay.ms]="index * 50"
          [disabled]="isTabletOrDesktop()"
        >
          <ion-item class="task-item" [class.task-completed]="task.done">
            <div class="task-checkbox-wrapper">
              <mat-checkbox
                [checked]="task.done"
                (change)="canClick() ? toggleTaskState(task.id) : null"
                [class.disabled]="!canClick()"
                matTooltip="Mark as complete"
                color="primary"
              ></mat-checkbox>
            </div>

            <div
              class="task-content"
              (click)="canClick() ? toggleTaskState(task.id) : null"
              [class.disabled]="!canClick()"
            >
              <ion-label class="task-label" [class.done]="task.done">
                <div class="task-title">{{ task?.title }}</div>
                @if(task.description){
                <div class="task-description">{{ task?.description }}</div>
                }
              </ion-label>
            </div>

            <div class="task-actions">
              <ion-button
                fill="clear"
                class="edit-button hidden md:flex"
                (click)="presentEditAlert(task)"
                matTooltip="Edit task"
              >
                <ion-icon slot="icon-only" name="create-outline"></ion-icon>
              </ion-button>
              <ion-icon
                slot="end"
                color="danger"
                name="trash-outline"
                (dblclick)="deleteTask(task.id)"
                class="delete-icon hidden sm:block"
                matTooltip="Double click to delete"
              ></ion-icon>
            </div>
          </ion-item>

          <ion-item-options side="start" class="item-options-start md:hidden">
            <ion-item-option color="tertiary" (click)="presentEditAlert(task)">
              <ion-icon slot="start" name="create-outline"></ion-icon>
              Edit
            </ion-item-option>
          </ion-item-options>

          <ion-item-options side="end" class="item-options-end">
            <ion-item-option (click)="deleteTask(task.id)" color="danger">
              <ion-icon slot="start" name="trash-outline"></ion-icon>
              Delete
            </ion-item-option>
          </ion-item-options>
        </ion-item-sliding>

        } @empty {

        <div class="empty-state">
          @if (alternativeFilterInfo()) {
          <!-- Smart filter suggestion -->
          <ion-icon
            name="funnel-outline"
            class="empty-icon empty-icon-subtle"
          ></ion-icon>
          <h3 class="empty-title">No tasks here</h3>
          <p class="empty-text">
            But you have {{ alternativeFilterInfo()!.count }} {{
            alternativeFilterInfo()!.label }}
          </p>
          <button
            class="filter-suggestion-button"
            (click)="switchToAlternativeFilter()"
          >
            <ion-icon name="arrow-forward-outline"></ion-icon>
            View {{ alternativeFilterInfo()!.label }}
          </button>
          } @else {
          <!-- Default empty state -->
          <ion-icon
            name="checkmark-done-circle-outline"
            class="empty-icon"
          ></ion-icon>
          <h3 class="empty-title">No Tasks Yet</h3>
          <p class="empty-text">Create your first task to get started!</p>
          }
        </div>

        }
      </div>
    </ion-list>
  </div>

  @if (hasNewTask()) {
  <div class="scroll-indicator">
    <ion-button shape="round" class="scroll-button" fill="clear">
      <ion-icon slot="icon-only" name="chevron-down-outline"></ion-icon>
    </ion-button>
  </div>
  } @if(this.userId()) {
  <ion-button
    shape="round"
    class="fab-button fab-refresh"
    [class.animate-spin]="mustRotate()"
    [class.animate-duration-500]="mustRotate()"
    (click)="refresh()"
    matTooltip="Sync tasks with cloud"
    matTooltipPosition="above"
    color="secondary"
  >
    <ion-icon
      slot="icon-only"
      aria-label="refresh button"
      name="sync"
    ></ion-icon>
  </ion-button>
  } @if (shouldShowInstall()) {
  <ion-button
    shape="round"
    class="fab-button fab-install"
    id="install-alert"
    color="primary"
    matTooltip="Install app"
    matTooltipPosition="above"
  >
    <mat-icon slot="icon-only">install_mobile</mat-icon>
  </ion-button>
  }
</ion-content>

<!-- Alerts -->

<ion-alert
  trigger="install-alert"
  [header]="'How to install'"
  [message]="alertMessages.InstallAlert"
  [buttons]="installButtons"
></ion-alert>
